<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="Collection">

    <sql id="nonpayListWhere">
        <where>
            <if test="taskId != null and taskId != ''">
                AND VMC.TASK_ID IN
                <foreach item="item" collection="taskId" open="(" separator="," close=")">
                    #{item}
                </foreach>
            </if>
            <if test="callId != null and callId != ''">
                AND MC.CALL_ID = #{callId}
            </if>
            /* 검색 조건 추가 */
            <if test="startDate != null and startDate != ''">
                AND DATE_FORMAT(MC.CALL_DT,'%Y-%m-%d') <![CDATA[ >= ]]> #{startDate}
            </if>
            <if test="endDate != null and endDate != ''">
                AND DATE_FORMAT(MC.CALL_DT,'%Y-%m-%d') <![CDATA[ <= ]]> #{endDate}
            </if>

            <if test="wrongGuide != null and wrongGuide != ''">
                AND IFNULL(MARI5.RESULT_VALUE,'N') = #{wrongGuide}
            </if>
            <if test="banned != null and banned != ''">
                AND IFNULL(MARI6.RESULT_VALUE,'N') = #{banned}
            </if>
            <if test="illegal != null and illegal != ''">
                AND IFNULL(MARI7.RESULT_VALUE,'N') = #{illegal}
            </if>
            <if test="paymentWill != null and paymentWill != ''">
                AND IFNULL(MARI8.RESULT_VALUE,'N') = #{paymentWill}
            </if>
            <if test="counselor != null and counselor != ''">
                AND MC.COUNSELOR_CD = #{counselor}
            </if>
            <if test="product != null and product != ''">
                AND VMC.TASK_ID = #{product}
            </if>
            <if test="progress != null and progress != ''">
                <if test="progress == 'C0031'">
                    AND MARI4.RESULT_VALUE_A = 'Y'
                </if>
                <if test="progress == 'C0032'">
                    AND MARI4.RESULT_VALUE_B = 'Y'
                </if>
                <if test="progress == 'C0033'">
                    AND MARI4.RESULT_VALUE_C = 'Y'
                </if>
            </if>
            <if test="recall != null and recall != ''">
                AND IFNULL(MARI1.RESULT_VALUE,'N') = #{recall}
            </if>
            <if test="reconfirm != null and reconfirm != ''">
                AND IFNULL(MARI3.RESULT_VALUE,'N') = #{reconfirm}
            </if>
            <if test="custNum != null and custNum != ''">
                AND MC.CUST_NUM = #{custNum}
            </if>
        </where>
    </sql>

    <sql id="searchListJoin">
        <choose>
            <when test="taskId[0] == 'TA0001'">
                LEFT JOIN (
                SELECT TASK_ID, CALL_ID, RESULT_VALUE FROM MSTR_ANALYSIS_RESULT
                WHERE ITEM_ID = 'I0005'
                AND RESULT_VALUE = 'Y'
                GROUP BY TASK_ID, CALL_ID, RESULT_VALUE
                ) MARI5
                ON MC.CALL_ID = MARI5.CALL_ID
                LEFT JOIN (
                SELECT TASK_ID, CALL_ID, RESULT_VALUE FROM MSTR_ANALYSIS_RESULT
                WHERE ITEM_ID = 'I0006'
                AND RESULT_VALUE = 'Y'
                GROUP BY TASK_ID, CALL_ID, RESULT_VALUE
                ) MARI6
                ON MC.CALL_ID = MARI6.CALL_ID
                LEFT JOIN (
                SELECT TASK_ID, CALL_ID, RESULT_VALUE FROM MSTR_ANALYSIS_RESULT
                WHERE ITEM_ID = 'I0007'
                AND RESULT_VALUE = 'Y'
                GROUP BY TASK_ID, CALL_ID, RESULT_VALUE
                ) MARI7
                ON MC.CALL_ID = MARI7.CALL_ID
                LEFT JOIN (
                SELECT TASK_ID, CALL_ID, RESULT_VALUE FROM MSTR_ANALYSIS_RESULT
                WHERE ITEM_ID = 'I0008'
                AND RESULT_VALUE = 'Y'
                GROUP BY TASK_ID, CALL_ID, RESULT_VALUE
                ) MARI8
                ON MC.CALL_ID = MARI8.CALL_ID
            </when>
            <when test="taskId[0] == 'TA0002'">
                LEFT JOIN (SELECT TASK_ID, CALL_ID, RESULT_VALUE
                FROM MSTR_ANALYSIS_RESULT
                WHERE ITEM_ID = 'I0011'
                AND CONTENT_ID = 'C0034'
                AND RESULT_VALUE = 'Y'
                GROUP BY TASK_ID, CALL_ID, RESULT_VALUE) MARI1 ON MC.CALL_ID = MARI1.CALL_ID
                LEFT JOIN (SELECT TASK_ID, CALL_ID, RESULT_VALUE
                FROM MSTR_ANALYSIS_RESULT
                WHERE ITEM_ID = 'I0011'
                AND CONTENT_ID = 'C0036'
                AND RESULT_VALUE <![CDATA[ <> ]]> 'N'
                GROUP BY TASK_ID, CALL_ID, RESULT_VALUE) MARI2 ON MC.CALL_ID = MARI2.CALL_ID
                LEFT JOIN (SELECT TASK_ID, CALL_ID, RESULT_VALUE
                FROM MSTR_ANALYSIS_RESULT
                WHERE ITEM_ID = 'I0012'
                AND CONTENT_ID = 'C0038'
                AND RESULT_VALUE = 'Y'
                GROUP BY TASK_ID, CALL_ID, RESULT_VALUE) MARI3 ON MC.CALL_ID = MARI3.CALL_ID
                LEFT JOIN (SELECT
                call_id,
                task_id,
                type_id,
                item_id,
                MAX(CASE WHEN content_id = 'C0031' THEN result_value END) AS result_value_a,
                MAX(CASE WHEN content_id = 'C0032' THEN result_value END) AS result_value_b,
                MAX(CASE WHEN content_id = 'C0033' THEN result_value END) AS result_value_c
                FROM mstr_analysis_result
                WHERE task_id = 'TA0002'
                AND type_id = 'T0004'
                AND item_id = 'I0010'
                AND content_id IN ('C0031','C0032','C0033')
                GROUP BY call_id, task_id, type_id, item_id) MARI4 ON MC.CALL_ID = MARI4.CALL_ID
            </when>
            <otherwise>
                LEFT JOIN (
                SELECT TASK_ID, CALL_ID, RESULT_VALUE FROM MSTR_ANALYSIS_RESULT
                WHERE ITEM_ID = 'I0034'
                AND CONTENT_ID = 'C0097'
                AND RESULT_VALUE = 'Y'
                GROUP BY TASK_ID, CALL_ID, RESULT_VALUE
                ) MARI1
                ON MC.CALL_ID = MARI1.CALL_ID
                LEFT JOIN (
                SELECT TASK_ID, CALL_ID, RESULT_VALUE FROM MSTR_ANALYSIS_RESULT
                WHERE ITEM_ID = 'I0043'
                AND CONTENT_ID = 'C0117'
                AND RESULT_VALUE = 'Y'
                GROUP BY TASK_ID, CALL_ID, RESULT_VALUE
                ) MARI2
                ON MC.CALL_ID = MARI2.CALL_ID
            </otherwise>
        </choose>
    </sql>

    <!-- 사후해피콜 상품 목록 조회 -->
    <select id="selectProductList" parameterType="hashmap" resultType="hashmap">
        <!-- Auto.selectProductList -->
        SELECT
        task_id AS "taskId"
        , REPLACE(name,'사후해피콜-','') AS "taskName"
        FROM mstr_task
        WHERE TASK_ID in ('TA0004','TA0005','TA0006','TA0007','TA0008')
    </select>

    <!-- resultType을 HashMap으로 지정 : 사용안함. -->
    <select id="selectCounselors" parameterType="hashmap" resultType="hashmap">
        <!-- Collection.selectCounselors -->
        SELECT
        counselor_cd AS "counselorCd",
        name AS "name",
        extension_num AS "extensionNum",
        task_name AS "taskName",
        reg_dt AS "regDt",
        upd_dt AS "updDt"
        FROM mstr_counselor
        <where>
            <if test="counselorCd != null and counselorCd != ''">
                AND counselor_cd = #{counselorCd}
            </if>
            <if test="name != null and name != ''">
                AND name LIKE CONCAT('%', #{name}, '%')
            </if>
            <if test="taskName != null and taskName != ''">
                AND task_name = #{taskName}
            </if>
        </where>
        ORDER BY reg_dt DESC
    </select>


    <!-- call 상세화면 대표정보 조회 -->
    <select id="selectMstrCallOne" parameterType="hashmap" resultType="hashmap">
        <!-- Collection.selectMstrCallOne -->
        SELECT DATE_FORMAT(A.CALL_DT,'%Y-%m-%d') AS "callDt"
            , A.CUST_NUM AS "custNum"
            , A.COUNSELOR_CD AS "counselorCd"
            , B.NAME AS "counselorName"
            , A.CALL_ID AS "callId"
            , C.TASK_NAME AS "taskName"
            , A.FILE_PATH AS "filePath"
        FROM MSTR_CALL A
        LEFT JOIN MSTR_COUNSELOR B
        ON A.COUNSELOR_CD = B.COUNSELOR_CD
        LEFT JOIN V_MSTR_CALL_TASK C
        ON A.CALL_ID = C.CALL_ID
        WHERE A.CALL_ID = #{callId}
    </select>

    <!-- call 목록 정보 조회 -->
    <select id="selectMstrNonpayList" parameterType="hashmap" resultType="hashmap">
        <!-- Collection.selectMstrNonpayList -->
        SELECT * FROM (
            SELECT
                @ROWNUM := @ROWNUM + 1 AS RNUM,
                A.*
            FROM (

            SELECT DATE_FORMAT(MC.CALL_DT,'%Y-%m-%d') AS "callDt"
                    , MC.CUST_NUM AS "custNum"
                    , MC.COUNSELOR_CD AS "counselorCd"
                    , MCS.NAME AS "counselorName"
                    , VMC.TASK_ID AS "taskId"
                    , VMC.TASK_NAME AS "taskName"
                    , MC.CALL_ID AS "callId"
                    , MAS.SCORE_VALUE AS "scoreValue"
              <choose>
                  <when test="taskId[0] == 'TA0001'">
                      , IFNULL(MARI5.RESULT_VALUE,'N') AS "item05"
                      , IFNULL(MARI6.RESULT_VALUE,'N') AS "item06"
                      , IFNULL(MARI7.RESULT_VALUE,'N') AS "item07"
                      , IFNULL(MARI8.RESULT_VALUE,'N') AS "item08"
                  </when>
                  <when test="taskId[0] == 'TA0002'">
                      , IFNULL(MARI1.RESULT_VALUE, 'N')     AS "item01"
                      , IFNULL(STR_TO_DATE(MARI2.RESULT_VALUE,'%Y%m%d%H%i'),CONCAT(SUBSTRING(MARI2.RESULT_VALUE,1,4),'-',SUBSTRING(MARI2.RESULT_VALUE,5,2))) AS "item02"
                      , IFNULL(MARI3.RESULT_VALUE, 'N')     AS "item03"
                      , CASE WHEN MARI4.result_value_a = 'Y' THEN '성사'
                          WHEN MARI4.result_value_b = 'Y' THEN '거절'
                          WHEN MARI4.result_value_c = 'Y' THEN '보류'
                          ELSE '' END AS "item04"
                  </when>
                  <otherwise>
                      , IFNULL(MARI1.RESULT_VALUE,'N') AS "item01"
                      , IFNULL(MARI2.RESULT_VALUE,'N') AS "item02"
                  </otherwise>
              </choose>
                FROM MSTR_CALL MC
                LEFT JOIN MSTR_COUNSELOR MCS
                ON MC.COUNSELOR_CD = MCS.COUNSELOR_CD
                LEFT JOIN V_MSTR_CALL_TASK VMC
                ON MC.CALL_ID = VMC.CALL_ID
                LEFT JOIN (
                    SELECT CALL_ID, TASK_ID, SCORE_ID, SCORE_VALUE FROM MSTR_ANALYSIS_SCORE
                    WHERE SCORE_ID IN
                        (
                            SELECT MIN(SCORE_ID) FROM MSTR_EVAL_SCORE_CONTENT
                            GROUP BY TASK_ID
                        )
                ) MAS
                ON MC.CALL_ID = MAS.CALL_ID
            <include refid="searchListJoin"/>
            <include refid="nonpayListWhere"/>
            <choose>
                <when test="sortOrder != null and sortOrder.size() > 0">
                    ORDER BY
                    <foreach collection="sortOrder" item="order" separator=",">
                        ${order.column} ${order.direction}
                    </foreach>
                </when>
                <otherwise>
                    ORDER BY callDt desc
                </otherwise>
            </choose>
            ) A, (SELECT @ROWNUM := 0) R
        ) B
        WHERE RNUM BETWEEN #{startRow} AND #{endRow}

    </select>


    <!-- 전체 건수 조회 -->
    <select id="selectMstrNonpayListCount" parameterType="hashmap" resultType="int">
        SELECT COUNT(*)
        FROM MSTR_CALL MC
        LEFT JOIN MSTR_COUNSELOR MCS
        ON MC.COUNSELOR_CD = MCS.COUNSELOR_CD
        LEFT JOIN V_MSTR_CALL_TASK VMC
        ON MC.CALL_ID = VMC.CALL_ID
        LEFT JOIN (
        SELECT CALL_ID, TASK_ID, SCORE_ID, SCORE_VALUE FROM MSTR_ANALYSIS_SCORE
        WHERE SCORE_ID IN
        (
        SELECT MIN(SCORE_ID) FROM MSTR_EVAL_SCORE_CONTENT
        GROUP BY TASK_ID
        )
        ) MAS
        ON MC.CALL_ID = MAS.CALL_ID
        <include refid="searchListJoin"/>
        <include refid="nonpayListWhere"/>
    </select>


</mapper>